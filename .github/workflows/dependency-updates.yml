name: Dependency Updates

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  update-dependencies:
    name: Check for Dependency Updates
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install npm-check-updates
      run: npm install -g npm-check-updates
    
    - name: Check for updates
      id: check
      run: |
        echo "## Dependency Update Report" > update-report.md
        echo "" >> update-report.md
        echo "Checking for available updates..." >> update-report.md
        ncu >> update-report.md || true
        
        # Check if updates are available
        if ncu --errorLevel 2 > /dev/null 2>&1; then
          echo "updates_available=false" >> $GITHUB_OUTPUT
        else
          echo "updates_available=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Create issue for updates
      if: steps.check.outputs.updates_available == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('update-report.md', 'utf8');
          
          // Check if an open issue already exists
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'dependencies'
          });
          
          const existingIssue = issues.data.find(issue => 
            issue.title.includes('Weekly Dependency Updates')
          );
          
          if (existingIssue) {
            // Update existing issue
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: existingIssue.number,
              body: `## New Update Check\n\nDate: ${new Date().toISOString()}\n\n${report}`
            });
          } else {
            // Create new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”„ Weekly Dependency Updates Available',
              body: `${report}\n\n---\n\n**Action Required:**\n1. Review the updates above\n2. Test critical packages (especially zwave-js) in a local environment\n3. Run \`npm update\` for patch updates or \`ncu -u\` for all updates\n4. Test lock/unlock, pairing, and code management\n5. Create a PR with the changes\n\n**Critical Packages to Test:**\n- \`zwave-js\` - Core Z-Wave functionality\n- \`express\` - API server\n- Security-related packages\n\n**Testing Checklist:**\n- [ ] TypeScript compilation\n- [ ] Lock/unlock operations\n- [ ] S0 pairing\n- [ ] User code management (CLI)\n- [ ] API endpoints\n- [ ] Web UI functionality`,
              labels: ['dependencies', 'maintenance']
            });
          }

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run security audit
      id: audit
      run: |
        npm audit --json > audit-results.json || true
        
        # Check for critical/high vulnerabilities
        CRITICAL=$(jq '.metadata.vulnerabilities.critical' audit-results.json)
        HIGH=$(jq '.metadata.vulnerabilities.high' audit-results.json)
        
        echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
        echo "high=$HIGH" >> $GITHUB_OUTPUT
    
    - name: Create security issue
      if: steps.audit.outputs.critical > 0 || steps.audit.outputs.high > 0
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const audit = JSON.parse(fs.readFileSync('audit-results.json', 'utf8'));
          
          const critical = '${{ steps.audit.outputs.critical }}';
          const high = '${{ steps.audit.outputs.high }}';
          
          let body = `## ðŸš¨ Security Vulnerabilities Detected\n\n`;
          body += `- **Critical:** ${critical}\n`;
          body += `- **High:** ${high}\n\n`;
          body += `### Recommended Actions\n\n`;
          body += `1. Run \`npm audit fix\` to auto-fix compatible issues\n`;
          body += `2. Review \`npm audit\` output for manual fixes\n`;
          body += `3. Test thoroughly after applying fixes\n`;
          body += `4. Consider temporary workarounds if no fix available\n\n`;
          body += `### Full Audit Output\n\n`;
          body += `\`\`\`\n`;
          body += JSON.stringify(audit, null, 2);
          body += `\n\`\`\``;
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ðŸš¨ Security Alert: ${critical} Critical, ${high} High Vulnerabilities`,
            body: body,
            labels: ['security', 'priority-high']
          });
